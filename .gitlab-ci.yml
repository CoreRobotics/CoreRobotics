image: camerondevine/corerobotics:latest

stages:
   - build
   - test
   - deploy

build-lib:
  stage: build
  script: 
   - mkdir build && cd build
   - cmake ..
   - make
  artifacts:
    paths:
     - $CI_PROJECT_DIR/lib/*
    expire_in: 1 week

build-python:
  stage: build
  script:
    - mkdir bin
    - mkdir build && cd build
    - cmake -Dpython=2 ..
    - make
  artifacts:
    paths:
      - $CI_PROJECT_DIR/lib/*
      - $CI_PROJECT_DIR/lib/python/*
      - $CI_PROJECT_DIR/bin/*
    expire_in: 1 week

build-test:
  stage: build
  script:
    - mkdir build && cd build
    - cmake -Dtests=true ..
    - make
    - $CI_PROJECT_DIR/bin/cr-tests
  artifacts:
    paths:
      - $CI_PROJECT_DIR/lib/*
      - $CI_PROJECT_DIR/bin/*
    expire_in: 1 week

test-python:
  stage: test
  script:
    - python $CI_PROJECT_DIR/bin/cr-example-core.py
    - python $CI_PROJECT_DIR/bin/cr-example-math.py
  dependencies:
    - build-python

test-lib:
  stage: test
  script:
    - $CI_PROJECT_DIR/bin/cr-tests
  dependencies:
    - build-test

deploy-install:
  stage: deploy
  script:
    - cd build
    - cmake -Dtests=true ..
    - make && make install
    - ldconfig /usr/local/lib
    - cr-tests
  dependencies:
    - build-test

deploy-coverage:
  stage: deploy
  script:
    - apt-get update && apt-get -y install lcov curl
    - cd build
    - cmake -Dreport=true ..
    - cmake --build . --config Debug
    - ctest --output-on-failure
  after_script:
    # Create lcov report
    - lcov --capture --directory . --output-file coverage.info
    - lcov --remove coverage.info '/usr/*' --output-file coverage.info # filter system-files
    - lcov --list coverage.info
    # Uploading to CodeCov
    - bash <(curl -s https://codecov.io/bash) -f coverage.info || echo "Codecov did not collect coverage reports"
  dependencies:
    - build-lib
